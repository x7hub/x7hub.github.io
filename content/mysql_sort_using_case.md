Date: 2014-5-29
Title: SQL中利用case语句根据多列排序
Category: sql
Tags: sql
Slug: mysql_sort_using_case

参考：

[oracle union all和order by一起使用](http://blog.csdn.net/chen_linbo/article/details/6396122)


 
 
需求是这样的，有类似如下的表，

```
+--------+------+-----+-----+------+---------+----------+
| userid | imei | lat | lon | addr | network | operator |
+--------+------+-----+-----+------+---------+----------+
| 122    | 343  |     |     |      | 3G      | 12344    |
| 123    | 345  |     |     |      | Wi-Fi   | 12345    |
| 124    | 346  |     |     |      | Wi-Fi   | 12345    |
| 125    | 347  |     |     |      | 3G      | 12345    |
| 126    | 348  |     |     |      | 3G      | 12346    |
| 127    | 349  |     |     |      | 3G      | 12347    |
| 128    | 350  |     |     |      | 3G      | 12343    |
| 129    | 351  |     |     |      | 3G      | 12345    |
| 130    | 352  |     |     |      | 2G      | 12345    |
| 131    | 353  |     |     |      | 4G      | 12345    |
| 133    | 354  |     |     |      | Wi-Fi   | 12346    |
+--------+------+-----+-----+------+---------+----------+
```

要对这个表排序输出，想要'network'为'Wi-Fi'的行在后，非'Wi-Fi'的行在前，而且两部分内分别按'operator'排序。也就是要得到如下的结果，

```
+--------+------+-----+-----+------+---------+----------+
| userid | imei | lat | lon | addr | network | operator |
+--------+------+-----+-----+------+---------+----------+
| 128    | 350  |     |     |      | 3G      | 12343    |
| 122    | 343  |     |     |      | 3G      | 12344    |
| 131    | 353  |     |     |      | 4G      | 12345    |
| 125    | 347  |     |     |      | 3G      | 12345    |
| 129    | 351  |     |     |      | 3G      | 12345    |
| 130    | 352  |     |     |      | 2G      | 12345    |
| 126    | 348  |     |     |      | 3G      | 12346    |
| 127    | 349  |     |     |      | 3G      | 12347    |
| 124    | 346  |     |     |      | Wi-Fi   | 12345    |
| 123    | 345  |     |     |      | Wi-Fi   | 12345    |
| 133    | 354  |     |     |      | Wi-Fi   | 12346    |
+--------+------+-----+-----+------+---------+----------+
```

### 利用union语句

容易想到`select`出'Wi-Fi'和非'Wi-Fi'两组结果，再用`union`将两组结果拼在一起。但是这两组结果还需要分别按'operator'排序，所以尝试这样，

```sql
select * from push_user_list
where network='Wi-Fi'
order by operator
union
select * from push_user_list
order by operator;
```

但是`union`的子句是不能用`order by`的，报错，

```
ERROR 1221 (HY000): Incorrect usage of UNION and ORDER BY
```

搜了一下，有人给出这样的方法，

```sql
select * from 
(select * from push_user_list where network<>'Wi-Fi' order by operator , network desc) t1
union
select * from
(select * from push_user_list where network='Wi-Fi' order by operator) t2;

```

看起来确实是个好主意，虽然据说在`Oracle SQL`测试可以通过，但是在我用的`MariaDB 5.5.37-1`结果排序却是错的，'operator'列并没有排序，

```
+--------+------+-----+-----+------+---------+----------+
| userid | imei | lat | lon | addr | network | operator |
+--------+------+-----+-----+------+---------+----------+
| 122    | 343  |     |     |      | 3G      | 12344    |
| 125    | 347  |     |     |      | 3G      | 12345    |
| 126    | 348  |     |     |      | 3G      | 12346    |
| 127    | 349  |     |     |      | 3G      | 12347    |
| 128    | 350  |     |     |      | 3G      | 12343    |
| 129    | 351  |     |     |      | 3G      | 12345    |
| 130    | 352  |     |     |      | 2G      | 12345    |
| 131    | 353  |     |     |      | 4G      | 12345    |
| 123    | 345  |     |     |      | Wi-Fi   | 12345    |
| 124    | 346  |     |     |      | Wi-Fi   | 12345    |
| 133    | 354  |     |     |      | Wi-Fi   | 12346    |
+--------+------+-----+-----+------+---------+----------+
```

### 利用case语句

从另一种思路考虑，放弃`union`的用法，把变量值用`case`或者`decode`表示，如果'network'是'Wi-Fi'就让排序的变量值为'~'，与'operator'列一起排序，这样就可以正常使用`order by`使'Wi-Fi'的行排在最后了，

```sql
select * from push_user_list
order by
case
when network='Wi-Fi' then '~'
else operator
end,
network desc;
```

这样的结果就很完美了，

```
+--------+------+-----+-----+------+---------+----------+
| userid | imei | lat | lon | addr | network | operator |
+--------+------+-----+-----+------+---------+----------+
| 128    | 350  |     |     |      | 3G      | 12343    |
| 122    | 343  |     |     |      | 3G      | 12344    |
| 131    | 353  |     |     |      | 4G      | 12345    |
| 125    | 347  |     |     |      | 3G      | 12345    |
| 129    | 351  |     |     |      | 3G      | 12345    |
| 130    | 352  |     |     |      | 2G      | 12345    |
| 126    | 348  |     |     |      | 3G      | 12346    |
| 127    | 349  |     |     |      | 3G      | 12347    |
| 124    | 346  |     |     |      | Wi-Fi   | 12345    |
| 123    | 345  |     |     |      | Wi-Fi   | 12345    |
| 133    | 354  |     |     |      | Wi-Fi   | 12346    |
+--------+------+-----+-----+------+---------+----------+
```



